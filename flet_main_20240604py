import flet as ft
import flet.canvas as cv
import inspect

def main(page: ft.Page):
    # Define the UI components
    page.title = "Neural Network Designer"
    page.vertical_alignment = ft.MainAxisAlignment.START

    def update_connect_layer(layers):
        print(design_area.content.shapes)
        design_area.content.shapes = []
        draw_line_list = []
        for layer in layers[:-1]:
            draw_line_list.append([layer.left+(layer.width//2),layer.top+layer.height])
        for i, layer in enumerate(layers[1:]):
            draw_line_list[i].append(layer.left+(layer.width//2))
            draw_line_list[i].append(layer.top)
        for draw_line_point in draw_line_list:
            design_area.content.shapes.append(
                cv.Line(
                    draw_line_point[0],
                    draw_line_point[1], 
                    draw_line_point[2], 
                    draw_line_point[3], 
                    ft.Paint(stroke_width=2, color=ft.colors.BLACK)
                )
            )
        design_area.update()
    
    def on_drag_update(e: ft.DragUpdateEvent):
        e.control.top = max(0, e.control.top + e.delta_y)
        e.control.left = max(0, e.control.left + e.delta_x)
        e.control.update()
        # print(design_area.content.controls)
        layer = sorted(design_area.content.content.controls[1:], key = lambda x:x.top)
        update_connect_layer(layer)

    def on_tap_layer(e):

        def on_change_activate(edrop):
            print(edrop.control.value)
            print(e.control.content.content.data)
            e.control.content.content.data["Default"]["activate"] = edrop.control.value
            e.control.update()

        # print(inspect.getmembers(e))
        print(e.control.content.content.value)
        print(e.control.content.content.data)
        params = []
        params.append(ft.Text(e.control.content.content.value, style="headlineMedium"),)
        params.append(ft.Text('input:'+str(e.control.content.content.data["Default"]["input"]), size=20))
        params.append(ft.Text('output:'+str(e.control.content.content.data["Default"]["output"]), size=20))
        params.append(ft.Row([
            ft.Text('activate:', size=20),
            ft.Dropdown(
                width=100,
                height=50,
                value=e.control.content.content.data["Default"]["activate"],
                on_change=on_change_activate,
                options=[
                    ft.dropdown.Option("relu"),
                    ft.dropdown.Option("softmax"),
                    ft.dropdown.Option("sigmoid"),
                ])
        ]))
        sidebar__layerparam_container.content.controls = params

        page.update()
    
        
    
    # Main design area with drag-and-drop functionality
    def add_layer(layer_type):
        data = {"Default":{"input":0,"output":0,"activate":None},"Dense":{"units":0},"Conv":{"kernel Size":(0,0)}}
        if layer_type == 'Dense':
            rect = ft.GestureDetector(
                content=ft.Container(content=ft.Text(layer_type), bgcolor=ft.colors.CYAN, border_radius=15),
                width=100,
                height=50,
                mouse_cursor=ft.MouseCursor.MOVE,
                drag_interval=10,
                top=100,
                left=50,
                on_vertical_drag_update=on_drag_update,
                on_tap=on_tap_layer,
            )
        elif layer_type == 'Conv':
            rect = ft.GestureDetector(
                content=ft.Container(content=ft.Text(layer_type), bgcolor=ft.colors.ORANGE, border_radius=15),
                width=100,
                height=50,
                mouse_cursor=ft.MouseCursor.MOVE,
                drag_interval=10,
                top=100,
                left=50,
                on_vertical_drag_update=on_drag_update,
                on_tap=on_tap_layer,
            )
        rect.content.content.data = data
        design_area.content.content.controls.append(rect)
        layer = sorted(design_area.content.content.controls[1:], key = lambda x:x.top)
        update_connect_layer(layer)
        page.update()

    # Sidebar with layer options
    sidebar_layers = ft.Column(
        [
            ft.Text("Layers", style="headlineMedium"),
            ft.ElevatedButton("Dense", on_click=lambda e: add_layer("Dense")),
            ft.ElevatedButton("Conv", on_click=lambda e: add_layer("Conv")),
        ],
        alignment=ft.MainAxisAlignment.START,
        expand=False,
    )
    sidebar_layers_container = ft.Container(
        sidebar_layers,
        expand=True,
        margin=1,
        padding=20,
        # bgcolor=ft.colors.GREY,
        border_radius=10,
        alignment=ft.alignment.top_left,
        # height=300,
        # width=200
    )

    sidebar_layerparam = ft.Column(
        [
            ft.Text("Layer Options", style="headlineMedium"),
        ],
        scroll=ft.ScrollMode.HIDDEN,
        alignment=ft.MainAxisAlignment.START,
        expand=False,
    )
    sidebar__layerparam_container = ft.Container(
        sidebar_layerparam,
        expand=True,
        margin=1,
        padding=20,
        bgcolor=ft.colors.CYAN,
        border_radius=10,
        alignment=ft.alignment.top_left,
        # height=300,
        # width=200
    )

    design_area = ft.Container(
        content=cv.Canvas(
            content=ft.Stack(
                [
                    ft.Text("Design", style="headlineMedium" ,text_align=ft.alignment.top_center)
                ],
                expand=True,    
            ),
            width=400,
            height=800,
            # bgcolor=ft.colors.BLUE,
            # border_radius=15
        )
    )

    # Preview area
    preview_area = ft.Container(
        content=ft.Column(
            [
                ft.Text("Preview", style="headlineMedium"),
                ft.Image(src="https://example.com/your_image.png", fit=ft.ImageFit.CONTAIN, height=300, width=300)
            ]),
        alignment=ft.alignment.top_center,
        expand=True,
        bgcolor=ft.colors.BLUE,
        border_radius=15
    )



    t = ft.Tabs(
        selected_index=1,
        animation_duration=300,
        tabs=[
            ft.Tab(
                tab_content=ft.Icon(ft.icons.FILE_COPY),
                content=ft.Text("save etc.."),
            ),
            ft.Tab(
                text="データ選択",
                icon=ft.icons.DATA_USAGE,
                content=ft.Text("data selection"),
            ),
            ft.Tab(
                text="前処理",
                icon=ft.icons.DATASET,
                content=ft.Text("data Preprocessing"),
            ),
            ft.Tab(
                text="モデル構築",
                icon=ft.icons.NUMBERS,
                content=ft.Row(
                    [
                        ft.Column(
                            [
                                sidebar_layers_container,
                                ft.Divider(color="black"),
                                sidebar__layerparam_container,
                            ]
                        ),
                        ft.VerticalDivider(width=1, color="black"),
                        design_area,
                        ft.VerticalDivider(width=1, color="black"),
                        preview_area,
                    ],
                    alignment=ft.MainAxisAlignment.START,
                    expand=True,
                )
                # ft.Container(
                #     content=ft.Text("This is Tab 1"), alignment=ft.alignment.center
                ),
            ft.Tab(
                text="オプション",
                icon=ft.icons.SETTINGS,
                content=ft.Text("This is Tab 3"),
            ),
        ],
        expand=1,
    )


    page.add(t)


# Start the app
ft.app(target=main)
